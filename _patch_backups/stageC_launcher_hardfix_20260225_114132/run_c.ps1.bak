param(
  [string]$IdeaDir = "",
  [string]$Mode = "fast"
)

# Windows PowerShell 5.1 friendly UTF-8
[Console]::InputEncoding  = New-Object System.Text.UTF8Encoding($false)
[Console]::OutputEncoding = New-Object System.Text.UTF8Encoding($false)
$OutputEncoding = [Console]::OutputEncoding
$ErrorActionPreference = "Stop"

function Say([string]$s){ Write-Host $s }
function LogLine([string]$logPath, [string]$s){ $s | Out-File -FilePath $logPath -Append -Encoding UTF8 }

$Root = Split-Path -Parent $PSScriptRoot
Set-Location $Root

# normalize Mode (без ??)
if ($null -eq $Mode) { $Mode = "" }
$Mode = ($Mode + "").Trim().ToLower()
if ([string]::IsNullOrWhiteSpace($Mode)) { $Mode = "fast" }
if ($Mode -ne "fast" -and $Mode -ne "deep") { $Mode = "fast" }

# logs
$LogDir = Join-Path $Root "launcher_logs"
New-Item -ItemType Directory -Force -Path $LogDir | Out-Null
$Log = Join-Path $LogDir "runC_last.log"
"" | Out-File -FilePath $Log -Encoding UTF8
$Log | Out-File -FilePath (Join-Path $LogDir "LAST_LOG.txt") -Encoding UTF8

function Resolve-IdeaDir([string]$arg) {
  $ideas = Join-Path $Root "ideas"
  if (-not (Test-Path $ideas)) { throw "Нет папки ideas. Сначала создай/выбери идею." }

  # 1) active idea
  if ([string]::IsNullOrWhiteSpace($arg)) {
    $active = Join-Path $ideas "_ACTIVE_PATH.txt"
    if (Test-Path $active) {
      $p = (Get-Content -LiteralPath $active -Raw).Trim()
      if ($p) {
        if (-not [IO.Path]::IsPathRooted($p)) { $p = Join-Path $Root $p }
        $p = [IO.Path]::GetFullPath($p)
        if (Test-Path $p) { return $p }
      }
    }
  }

  # 2) explicit arg
  if ($arg -and $arg.Trim()) {
    $p = $arg
    if (-not [IO.Path]::IsPathRooted($p)) { $p = Join-Path $Root $p }
    $p = [IO.Path]::GetFullPath($p)
    if ((Split-Path -Leaf $p) -ieq "out") { $p = Split-Path -Parent $p }
    if (-not (Test-Path $p)) { throw "Папка идеи не найдена: $p" }
    return $p
  }

  # 3) newest IDEA-*
  $cands = Get-ChildItem -LiteralPath $ideas -Directory -ErrorAction SilentlyContinue |
           Where-Object { $_.Name -like "IDEA-*" } |
           Sort-Object Name -Descending
  $first = $cands | Select-Object -First 1
  if ($first) { return $first.FullName }

  throw "В папке ideas нет ни одной IDEA-*"
}

function Ensure-IdeaLayout([string]$ideaDir){
  New-Item -ItemType Directory -Force -Path (Join-Path $ideaDir "in"),(Join-Path $ideaDir "out"),(Join-Path $ideaDir "logs") | Out-Null
}

function Extract-JsonObject([string]$text){
  $s = $text
  $i0 = $s.IndexOf("{")
  $i1 = $s.LastIndexOf("}")
  if ($i0 -lt 0 -or $i1 -le $i0) { return $null }
  return $s.Substring($i0, ($i1-$i0+1))
}

function Restore-StructuredIdeaIfMissing([string]$ideaDir, [string]$logPath){
  $inDir  = Join-Path $ideaDir "in"
  $outDir = Join-Path $ideaDir "out"
  $dst    = Join-Path $outDir "structured_idea.json"
  if (Test-Path $dst) { return $true }

  $src = Join-Path $inDir "llm_response.json"
  if (-not (Test-Path $src)) { return $false }

  try {
    $raw = [System.IO.File]::ReadAllText($src, [System.Text.Encoding]::UTF8)
    $json = Extract-JsonObject $raw
    if (-not $json) { return $false }

    # пишем JSON без BOM
    [System.IO.File]::WriteAllText($dst, $json, (New-Object System.Text.UTF8Encoding($false)))
    LogLine $logPath "[INFO] Восстановил out\structured_idea.json из in\llm_response.json (Stage B мог очистить out)."
    return $true
  } catch { return $false }
}

try {
  $IdeaDir = Resolve-IdeaDir $IdeaDir
  $IdeaDir = (Resolve-Path $IdeaDir).Path
  Ensure-IdeaLayout $IdeaDir

  $ideaName = Split-Path $IdeaDir -Leaf
  $outDir = Join-Path $IdeaDir "out"
  $inDir  = Join-Path $IdeaDir "in"

  Say "Stage C (Evidence Table) — идея: $ideaName"
  Say "Режим: $Mode (fast=быстро, deep=глубже)"
  LogLine $Log "[INFO] IDEA=$IdeaDir"
  LogLine $Log "[INFO] MODE=$Mode"

  $corpus = Join-Path $outDir "corpus.csv"
  if (-not (Test-Path $corpus)) {
    Say ""
    Say "❌ Не найден out\corpus.csv. Сначала запусти RUN_B.bat"
    exit 1
  }

  if (-not (Restore-StructuredIdeaIfMissing $IdeaDir $Log)) {
    Say ""
    Say "❌ Не найден out\structured_idea.json и не получилось восстановить."
    Say "Сначала: RUN_A.bat → затем RUN_B.bat → затем RUN_C.bat"
    exit 1
  }

  $py = Join-Path $Root ".venv\Scripts\python.exe"
  if (-not (Test-Path $py)) { throw "Не найден .venv. Запусти 0_SETUP.bat" }

  $script = Join-Path $Root "tools\c_evidence_engine.py"
  if (-not (Test-Path $script)) { throw "Не найден tools\c_evidence_engine.py" }

  # если python-скрипт поддерживает --mode, добавим; если нет — не добавим (для совместимости)
  $pyText = ""
  try { $pyText = [System.IO.File]::ReadAllText($script, [System.Text.Encoding]::UTF8) } catch { $pyText = "" }
  $hasMode = $false
  if ($pyText -match "--mode") { $hasMode = $true }

  $args = @($script, "--idea", $IdeaDir)
  if ($hasMode) { $args += @("--mode", $Mode) }

  LogLine $Log ("[CMD] " + $py + " " + ($args -join " "))
  & $py @args 2>&1 | Tee-Object -FilePath $Log -Append | Out-Host
  $rc = $LASTEXITCODE

  if ($rc -eq 0) {
    Say ""
    Say "✅ Stage C готова."
    Say "Файлы результата:"
    Say "  - out\evidence_table.csv"
    Say "  - out\evidence_summary.md"
    $sum = Join-Path $outDir "evidence_summary.md"
    if (Test-Path $sum) { Start-Process notepad.exe -ArgumentList $sum | Out-Null }
    Start-Process explorer.exe -ArgumentList $IdeaDir | Out-Null
    exit 0
  }

  if ($rc -eq 2) {
    $prompt = Join-Path $outDir "llm_prompt_C.txt"
    $resp   = Join-Path $inDir  "llm_evidence.json"

    Say ""
    Say "Нужен ChatGPT (1 раз). Делай так:"
    Say "1) PROMPT уже в буфере (Ctrl+V в ChatGPT)."
    Say "2) В ChatGPT вставь PROMPT и отправь."
    Say "3) Из ответа скопируй ТОЛЬКО JSON (без текста)."
    Say "4) Вставь JSON в файл: in\llm_evidence.json, сохрани."
    Say "5) Запусти RUN_C.bat ещё раз."

    if (Test-Path $prompt) {
      Set-Clipboard -Value ([System.IO.File]::ReadAllText($prompt,[System.Text.Encoding]::UTF8))
      Start-Process notepad.exe -ArgumentList $prompt | Out-Null
    }
    if (-not (Test-Path $resp)) { New-Item -ItemType File -Force -Path $resp | Out-Null }
    Start-Process notepad.exe -ArgumentList $resp | Out-Null
    Start-Process explorer.exe -ArgumentList $IdeaDir | Out-Null
    exit 2
  }

  Say ""
  Say "❌ Stage C: ошибка (ExitCode=$rc). Открою лог."
  Start-Process notepad.exe -ArgumentList $Log | Out-Null
  exit 1
}
catch {
  Say ""
  Say "❌ Stage C: ошибка запуска. Открою лог."
  $_ | Out-String | Out-File -FilePath $Log -Append -Encoding UTF8
  Start-Process notepad.exe -ArgumentList $Log | Out-Null
  exit 1
}