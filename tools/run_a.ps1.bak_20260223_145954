param([string]$IdeaDir = "")

$ErrorActionPreference = "Stop"

$Root = Split-Path -Parent $PSScriptRoot
Set-Location $Root

$LogDir = Join-Path $Root "launcher_logs"
New-Item -ItemType Directory -Force -Path $LogDir | Out-Null
$stamp = Get-Date -Format "yyyyMMdd_HHmmss"
$Log = Join-Path $LogDir ("runA_" + $stamp + ".log")
$Log | Out-File -FilePath (Join-Path $LogDir "LAST_LOG.txt") -Encoding UTF8

function LogLine([string]$s) {
  $ts = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
  "$ts $s" | Out-File -FilePath $Log -Append -Encoding UTF8
  Write-Host $s
}

function Resolve-IdeaDir([string]$arg) {
  $ideas = Join-Path $Root "ideas"
  if (-not (Test-Path $ideas)) { throw "Missing folder: $ideas (run 1_NEW_IDEA.bat)" }

  # Prefer ACTIVE idea if no arg
  if ([string]::IsNullOrWhiteSpace($arg)) {
    $active = Join-Path $ideas "_ACTIVE_PATH.txt"
    if (Test-Path $active) {
      $p = (Get-Content -LiteralPath $active -Raw).Trim()
      if ($p) {
        if (-not [IO.Path]::IsPathRooted($p)) { $p = Join-Path $Root $p }
        $p = [IO.Path]::GetFullPath($p)
        if (Test-Path $p) { return $p }
      }
    }
  }

  # Use arg if given
  if ($arg -and $arg.Trim()) {
    $p = $arg
    if (-not [IO.Path]::IsPathRooted($p)) { $p = Join-Path $Root $p }
    $p = [IO.Path]::GetFullPath($p)
    if ((Split-Path -Leaf $p) -ieq "out") { $p = Split-Path -Parent $p }
    if (-not (Test-Path $p)) { throw "Idea folder not found: $p" }
    return $p
  }

  # Fallback: newest IDEA-* by name
  $cands = Get-ChildItem -LiteralPath $ideas -Directory -ErrorAction SilentlyContinue |
           Where-Object { $_.Name -like "IDEA-*" } |
           Sort-Object Name -Descending
  $first = $cands | Select-Object -First 1
  if ($first) { return $first.FullName }

  throw "No IDEA-* folder found in $ideas"
}

function Ensure-IdeaLayout([string]$ideaDir) {
  $inDir   = Join-Path $ideaDir "in"
  $outDir  = Join-Path $ideaDir "out"
  $logsDir = Join-Path $ideaDir "logs"
  New-Item -ItemType Directory -Force -Path $inDir,$outDir,$logsDir | Out-Null

  $ideaTop = Join-Path $ideaDir "idea.txt"
  $ideaIn  = Join-Path $inDir "idea.txt"

  # If user edits in\idea.txt, sync it to idea.txt (module_a.py reads idea.txt)
  if (Test-Path $ideaIn) {
    if ((-not (Test-Path $ideaTop)) -or ((Get-Item $ideaIn).LastWriteTime -gt (Get-Item $ideaTop).LastWriteTime)) {
      Copy-Item -Force -LiteralPath $ideaIn -Destination $ideaTop
    }
  }

  if (-not (Test-Path $ideaTop)) {
    throw "Missing idea text: $ideaTop (create idea and fill idea.txt)"
  }
}

try {
  LogLine "[DIAG] Root=$Root"
  LogLine "[DIAG] IdeaDir(arg)='$IdeaDir'"

  $IdeaDir = Resolve-IdeaDir $IdeaDir
  $IdeaDir = (Resolve-Path $IdeaDir).Path
  LogLine "[INFO] Using idea folder: $IdeaDir"

  Ensure-IdeaLayout $IdeaDir

  $py = Join-Path $Root ".venv\Scripts\python.exe"
  $script = Join-Path $Root "tools\module_a.py"
  if (-not (Test-Path $py)) { throw "Python venv not found: $py (run 0_SETUP.bat)" }
  if (-not (Test-Path $script)) { throw "Not found: $script" }

  LogLine "[CMD] $py $script --idea `"$IdeaDir`""

  $oldEAP = $ErrorActionPreference
  $ErrorActionPreference = "Continue"
  & $py $script --idea $IdeaDir 2>&1 | Tee-Object -FilePath $Log -Append | Out-Host
  $ErrorActionPreference = $oldEAP

  $rc = $LASTEXITCODE
  LogLine "[DIAG] ExitCode=$rc"

  if ($rc -eq 2) {
    $prompt = Join-Path $IdeaDir "out\llm_prompt.txt"
    $promptA = Join-Path $IdeaDir "out\llm_prompt_A.txt"
    $target = Join-Path $IdeaDir "in\llm_response.json"

    if (Test-Path $prompt) {
      Copy-Item -Force -LiteralPath $prompt -Destination $promptA -ErrorAction SilentlyContinue
      Set-Clipboard -Value (Get-Content -Raw -LiteralPath $prompt)
      LogLine "[OK] Prompt copied to clipboard."
      LogLine "[NEXT] Paste prompt into ChatGPT."
      LogLine "[NEXT] Copy ONLY JSON and replace file: $target"
      LogLine "[NEXT] Save and rerun RUN_A.bat"

      if (-not (Test-Path $target)) {
        New-Item -ItemType File -Force -Path $target | Out-Null
      }
      Start-Process notepad.exe -ArgumentList $target | Out-Null
      Start-Process explorer.exe -ArgumentList $IdeaDir | Out-Null
    } else {
      LogLine "[WARN] Prompt not found: $prompt"
    }
  }

  exit $rc
}
catch {
  LogLine ("[FATAL] " + $_.Exception.Message)
  LogLine ($_.ScriptStackTrace | Out-String)
  exit 1
}