param(
  [string]$IdeaDir = "",
  [string]$Mode = "fast"
)

# Windows PowerShell 5.1: принудительно UTF-8 для консоли
[Console]::InputEncoding  = New-Object System.Text.UTF8Encoding($false)
[Console]::OutputEncoding = New-Object System.Text.UTF8Encoding($false)
$OutputEncoding = [Console]::OutputEncoding
$ErrorActionPreference = "Stop"

function Say([string]$s){ Write-Host $s }

# Логи лаунчера
$Root = Split-Path -Parent $PSScriptRoot
Set-Location $Root
$LogDir = Join-Path $Root "launcher_logs"
New-Item -ItemType Directory -Force -Path $LogDir | Out-Null
$Log = Join-Path $LogDir "runC_last.log"
"" | Out-File -FilePath $Log -Encoding UTF8

function LogLine([string]$s){
  $s | Out-File -FilePath $Log -Append -Encoding UTF8
}

# mode normalize (PS 5.1 safe)
if ($null -eq $Mode) { $Mode = "" }
$Mode = ($Mode + "").Trim().ToLower()
if ([string]::IsNullOrWhiteSpace($Mode)) { $Mode = "fast" }
if ($Mode -ne "fast" -and $Mode -ne "deep") { $Mode = "fast" }

function Resolve-IdeaDir([string]$arg) {
  $ideas = Join-Path $Root "ideas"
  if (-not (Test-Path $ideas)) { throw "Нет папки ideas." }

  if ([string]::IsNullOrWhiteSpace($arg)) {
    $active = Join-Path $ideas "_ACTIVE_PATH.txt"
    if (Test-Path $active) {
      $p = (Get-Content -LiteralPath $active -Raw).Trim()
      if ($p) {
        if (-not [IO.Path]::IsPathRooted($p)) { $p = Join-Path $Root $p }
        $p = [IO.Path]::GetFullPath($p)
        if (Test-Path $p) { return $p }
      }
    }
  }

  if ($arg -and $arg.Trim()) {
    $p = $arg
    if (-not [IO.Path]::IsPathRooted($p)) { $p = Join-Path $Root $p }
    $p = [IO.Path]::GetFullPath($p)
    if ((Split-Path -Leaf $p) -ieq "out") { $p = Split-Path -Parent $p }
    if (-not (Test-Path $p)) { throw "Папка идеи не найдена: $p" }
    return $p
  }

  $cands = Get-ChildItem -LiteralPath $ideas -Directory -ErrorAction SilentlyContinue |
           Where-Object { $_.Name -like "IDEA-*" } |
           Sort-Object Name -Descending
  $first = $cands | Select-Object -First 1
  if ($first) { return $first.FullName }

  throw "В папке ideas нет ни одной IDEA-*"
}

function Ensure-IdeaLayout([string]$ideaDir){
  New-Item -ItemType Directory -Force -Path (Join-Path $ideaDir "in"),(Join-Path $ideaDir "out"),(Join-Path $ideaDir "logs") | Out-Null
}

function Extract-JsonObject([string]$text){
  $i0 = $text.IndexOf("{")
  $i1 = $text.LastIndexOf("}")
  if ($i0 -lt 0 -or $i1 -le $i0) { return $null }
  return $text.Substring($i0, ($i1-$i0+1))
}

function Restore-StructuredIdeaIfMissing([string]$ideaDir){
  $dst = Join-Path $ideaDir "out\structured_idea.json"
  if (Test-Path $dst) { return $true }

  $src = Join-Path $ideaDir "in\llm_response.json"
  if (-not (Test-Path $src)) { return $false }

  try {
    $raw = [System.IO.File]::ReadAllText($src, [System.Text.Encoding]::UTF8)
    $json = Extract-JsonObject $raw
    if (-not $json) { return $false }
    [System.IO.File]::WriteAllText($dst, $json, (New-Object System.Text.UTF8Encoding($false)))
    LogLine "[INFO] Restored out\structured_idea.json from in\llm_response.json"
    return $true
  } catch {
    return $false
  }
}

try {
  $IdeaDir = Resolve-IdeaDir $IdeaDir
  $IdeaDir = (Resolve-Path $IdeaDir).Path
  Ensure-IdeaLayout $IdeaDir

  $ideaName = Split-Path $IdeaDir -Leaf
  Say "Stage C launcher: $ideaName"
  Say "Mode: $Mode (fast/deep)"
  LogLine "[INFO] IDEA=$IdeaDir"
  LogLine "[INFO] MODE=$Mode"

  $corpus = Join-Path $IdeaDir "out\corpus.csv"
  if (-not (Test-Path $corpus)) {
    Say "ERROR: out\corpus.csv not found. Run RUN_B.bat first."
    exit 1
  }

  if (-not (Restore-StructuredIdeaIfMissing $IdeaDir)) {
    Say "ERROR: out\structured_idea.json not found and restore failed. Run RUN_A then RUN_B then RUN_C."
    exit 1
  }

  $py = Join-Path $Root ".venv\Scripts\python.exe"
  if (-not (Test-Path $py)) { throw "Python venv not found (.venv). Run 0_SETUP.bat" }

  $script = Join-Path $Root "tools\c_evidence_engine.py"
  if (-not (Test-Path $script)) { throw "Missing tools\c_evidence_engine.py" }

  # call python (add --mode only if script supports it)
  $pyText = ""
  try { $pyText = [System.IO.File]::ReadAllText($script, [System.Text.Encoding]::UTF8) } catch { $pyText = "" }
  $hasMode = $false
  if ($pyText -match "--mode") { $hasMode = $true }

  $args = @($script, "--idea", $IdeaDir)
  if ($hasMode) { $args += @("--mode", $Mode) }

  LogLine ("[CMD] " + $py + " " + ($args -join " "))
  & $py @args 2>&1 | Tee-Object -FilePath $Log -Append | Out-Host
  $rc = $LASTEXITCODE

  if ($rc -eq 0) {
    Say "OK: Stage C complete."
    Say "Outputs: out\evidence_table.csv ; out\evidence_summary.md"
    exit 0
  }

  if ($rc -eq 2) {
    $prompt = Join-Path $IdeaDir "out\llm_prompt_C.txt"
    $resp   = Join-Path $IdeaDir "in\llm_evidence.json"

    Say "Need ChatGPT once:"
    Say "1) Prompt is copied to clipboard (Ctrl+V in ChatGPT)"
    Say "2) Copy ONLY JSON from ChatGPT answer"
    Say "3) Paste JSON into in\llm_evidence.json and save"
    Say "4) Run RUN_C.bat again"

    if (Test-Path $prompt) {
      Set-Clipboard -Value ([System.IO.File]::ReadAllText($prompt,[System.Text.Encoding]::UTF8))
      Start-Process notepad.exe -ArgumentList $prompt | Out-Null
    }
    if (-not (Test-Path $resp)) { New-Item -ItemType File -Force -Path $resp | Out-Null }
    Start-Process notepad.exe -ArgumentList $resp | Out-Null
    Start-Process explorer.exe -ArgumentList $IdeaDir | Out-Null
    exit 2
  }

  Say ("ERROR: Stage C failed, exit code=" + $rc + ". See launcher_logs\runC_last.log")
  Start-Process notepad.exe -ArgumentList $Log | Out-Null
  exit 1
}
catch {
  Say "ERROR: launcher crashed. Opening log."
  $_ | Out-String | Out-File -FilePath $Log -Append -Encoding UTF8
  Start-Process notepad.exe -ArgumentList $Log | Out-Null
  exit 1
}