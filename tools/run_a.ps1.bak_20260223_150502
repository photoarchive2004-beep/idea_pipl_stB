param([string]$IdeaDir = "")

$ErrorActionPreference = "Stop"
$Root = Split-Path -Parent $PSScriptRoot
Set-Location $Root

$LogDir = Join-Path $Root "launcher_logs"
New-Item -ItemType Directory -Force -Path $LogDir | Out-Null
$stamp = Get-Date -Format "yyyyMMdd_HHmmss"
$Log = Join-Path $LogDir ("runA_" + $stamp + ".log")
$Log | Out-File -FilePath (Join-Path $LogDir "LAST_LOG.txt") -Encoding UTF8

function LogLine([string]$s) {
  $ts = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
  "$ts $s" | Out-File -FilePath $Log -Append -Encoding UTF8
  Write-Host $s
}

function Resolve-IdeaDir([string]$arg) {
  $ideas = Join-Path $Root "ideas"
  if (-not (Test-Path $ideas)) { throw "Missing ideas folder. Run 1_NEW_IDEA.bat first." }

  if ([string]::IsNullOrWhiteSpace($arg)) {
    $active = Join-Path $ideas "_ACTIVE_PATH.txt"
    if (Test-Path $active) {
      $p = (Get-Content -LiteralPath $active -Raw).Trim()
      if ($p) {
        if (-not [IO.Path]::IsPathRooted($p)) { $p = Join-Path $Root $p }
        $p = [IO.Path]::GetFullPath($p)
        if (Test-Path $p) { return $p }
      }
    }
  }

  if ($arg -and $arg.Trim()) {
    $p = $arg
    if (-not [IO.Path]::IsPathRooted($p)) { $p = Join-Path $Root $p }
    $p = [IO.Path]::GetFullPath($p)
    if ((Split-Path -Leaf $p) -ieq "out") { $p = Split-Path -Parent $p }
    if (-not (Test-Path $p)) { throw "Idea folder not found: $p" }
    return $p
  }

  $cands = Get-ChildItem -LiteralPath $ideas -Directory -ErrorAction SilentlyContinue |
           Where-Object { $_.Name -like "IDEA-*" } |
           Sort-Object Name -Descending
  $first = $cands | Select-Object -First 1
  if ($first) { return $first.FullName }

  throw "No IDEA-* folder found."
}

function Ensure-IdeaLayout([string]$ideaDir) {
  $inDir   = Join-Path $ideaDir "in"
  $outDir  = Join-Path $ideaDir "out"
  $logsDir = Join-Path $ideaDir "logs"
  New-Item -ItemType Directory -Force -Path $inDir,$outDir,$logsDir | Out-Null

  $ideaTop = Join-Path $ideaDir "idea.txt"
  $ideaIn  = Join-Path $inDir "idea.txt"

  # sync in\idea.txt -> idea.txt if newer
  if (Test-Path $ideaIn) {
    if ((-not (Test-Path $ideaTop)) -or ((Get-Item $ideaIn).LastWriteTime -gt (Get-Item $ideaTop).LastWriteTime)) {
      Copy-Item -Force -LiteralPath $ideaIn -Destination $ideaTop
    }
  }

  if (-not (Test-Path $ideaTop)) {
    throw "Missing idea text: idea.txt (fill it first)."
  }
}

function Find-PromptFile([string]$outDir) {
  if (-not (Test-Path $outDir)) { return $null }

  # Common names first
  $common = @(
    "llm_prompt.txt","llm_prompt_A.txt","llm_prompt_stageA.txt",
    "prompt.txt","prompt_A.txt","chatgpt_prompt.txt","PROMPT.txt"
  )
  foreach ($n in $common) {
    $p = Join-Path $outDir $n
    if (Test-Path $p) { return $p }
  }

  # Any *prompt*.(txt|md) newest
  $cand = Get-ChildItem -LiteralPath $outDir -Recurse -File -ErrorAction SilentlyContinue |
          Where-Object { $_.Name -match '(?i)prompt' -and $_.Extension -in '.txt','.md' } |
          Sort-Object LastWriteTime -Descending |
          Select-Object -First 1
  if ($cand) { return $cand.FullName }

  return $null
}

try {
  LogLine "[DIAG] Root=$Root"
  $IdeaDir = Resolve-IdeaDir $IdeaDir
  $IdeaDir = (Resolve-Path $IdeaDir).Path
  LogLine "[INFO] Using idea folder: $IdeaDir"

  Ensure-IdeaLayout $IdeaDir

  $py = Join-Path $Root ".venv\Scripts\python.exe"
  $script = Join-Path $Root "tools\module_a.py"
  if (-not (Test-Path $py)) { throw "Python venv not found (.venv). Run 0_SETUP.bat" }
  if (-not (Test-Path $script)) { throw "module_a.py not found." }

  LogLine "[CMD] $py $script --idea `"$IdeaDir`""

  $old = $ErrorActionPreference
  $ErrorActionPreference = "Continue"
  & $py $script --idea $IdeaDir 2>&1 | Tee-Object -FilePath $Log -Append | Out-Host
  $ErrorActionPreference = $old

  $rc = $LASTEXITCODE
  LogLine "[DIAG] ExitCode=$rc"

  if ($rc -eq 2) {
    $outDir = Join-Path $IdeaDir "out"
    $promptFile = Find-PromptFile $outDir

    $target = Join-Path $IdeaDir "in\llm_response.json"
    if (-not (Test-Path $target)) { New-Item -ItemType File -Force -Path $target | Out-Null }

    # Always open folder + response file
    Start-Process explorer.exe -ArgumentList $IdeaDir | Out-Null
    Start-Process notepad.exe  -ArgumentList $target | Out-Null

    if ($promptFile) {
      Set-Clipboard -Value (Get-Content -Raw -LiteralPath $promptFile)
      LogLine "[OK] Prompt copied to clipboard."
      Start-Process notepad.exe -ArgumentList $promptFile | Out-Null
    } else {
      LogLine "[WARN] Prompt file not found in out\ ."
      LogLine "[HINT] Check python output/logs or module_a.py output naming."
    }
  }

  exit $rc
}
catch {
  LogLine ("[FATAL] " + $_.Exception.Message)
  LogLine ($_.ScriptStackTrace | Out-String)
  exit 1
}